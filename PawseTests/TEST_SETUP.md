# Test Setup Guide

## Quick Start (No Configuration Needed!)

Your Firestore security rules already allow all authenticated users to read and write:

```
allow read, write: if request.auth != null;
```

✅ **No security rule changes needed!**

## One-Time Setup: Create Test User

Just create ONE user account in Firebase Authentication:

**Email:** `test@pawse.com`  
**Password:** `TestPassword123!`

Steps:
1. Go to Firebase Console → Your Project → Authentication
2. Click "Add user" button
3. Enter email: `test@pawse.com`
4. Enter password: `TestPassword123!`
5. Click "Create"

That's it! Now all tests will work.

## How Tests Work

1. Tests call `TestHelper.ensureTestUserSignedIn()` at the start
2. This signs in the test user (test@pawse.com)
3. Firestore operations now work because the user is authenticated
4. Your security rules allow authenticated users to do everything

## Running Tests

### Run All Controller Tests
```bash
xcodebuild test -scheme Pawse -destination 'platform=iOS Simulator,name=iPhone 15' -only-testing:PawseTests/ControllerTests
```

### Run Specific Test
```bash
# Contest Controller tests
xcodebuild test -scheme Pawse -only-testing:PawseTests/ControllerTests/ContestControllerTests
```

### Run in Xcode
1. Open test navigator (Cmd + 6)
2. Click play button next to the test

## Troubleshooting

### Tests still fail with "Missing or insufficient permissions"
1. Verify test user exists: Firebase Console → Authentication → Users
2. Check that the email is exactly `test@pawse.com` and password is `TestPassword123!`
3. Try creating a fresh test user if it doesn't exist

### Sign-in fails with "user does not have a password"
- Delete the test user and create it again
- Make sure you're creating it as "Email/password" type

### Tests pass but data looks wrong
- Tests create unique test data using UUIDs
- Check Firestore collections for documents with "Test" in the name or UUID prefixes
- You can delete them manually from Firebase Console if needed

## Notes

- Auth tests create and delete their own users
- Other tests use the shared test user (test@pawse.com with UID: 1IU4XCi1oNewCD7HEULziOLjExg1)
- Tests create unique data to avoid conflicts (uses UUIDs)
- Tests include delays for Firestore to process (500ms)

### Create Test User Document (RECOMMENDED)
Create a user document in Firestore at `users/{uid}` (use the UID generated by Firebase):

```json
{
  "email": "test@pawse.com",
  "nick_name": "Test User",
  "pets": [],
  "preferred_setting": [],
  "has_seen_profile_tutorial": false
}
```

This step is optional - some tests may create it automatically if needed.

## Firestore Security Rules

Your Firestore security rules need to allow authenticated users to read and write data. Here's a minimal configuration for testing:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
    
    // Pets collection
    match /pets/{petId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }
    
    // Photos collection
    match /photos/{photoId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }
    
    // Connections collection
    match /connections/{connectionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }
    
    // Guardians (coowners) collection
    match /coowners/{coownerId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }
    
    // Contests collection
    match /contests/{contestId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }
    
    // Contest photos collection
    match /contest_photos/{contestPhotoId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }
  }
}
```

## How Tests Work

1. **TestHelper.ensureTestUserSignedIn()** is called at the start of each test
2. This method checks if a user is already signed in
3. If not, it signs in using the test credentials
4. Tests then run with proper authentication
5. Firestore operations succeed because the user is authenticated

## Running Tests

### Run All Controller Tests
```bash
xcodebuild test -scheme Pawse -destination 'platform=iOS Simulator,name=iPhone 15' -only-testing:PawseTests/ControllerTests
```

### Run Specific Test File
```bash
# Auth Controller tests
xcodebuild test -scheme Pawse -only-testing:PawseTests/AuthControllerTests

# User Controller tests
xcodebuild test -scheme Pawse -only-testing:PawseTests/UserControllerTests

# Connection Controller tests
xcodebuild test -scheme Pawse -only-testing:PawseTests/ConnectionControllerTests
```

### Run in Xcode
1. Open the test navigator (Cmd + 6)
2. Select the test(s) you want to run
3. Click the play button next to the test

## Troubleshooting

### "Missing or insufficient permissions" Error
**This is the most common issue.**

**Solution Checklist:**
1. ✅ Did you deploy the Firestore security rules shown at the top? (Not just view them - you must PUBLISH)
2. ✅ Did you wait for the rules to deploy? (Check top of Firebase console for "Deployment complete")
3. ✅ Did you create the test user (test@pawse.com) in Firebase Authentication?
4. ✅ Are you using the correct Firebase project in GoogleService-Info.plist?

**If still failing:**
1. Go to Firebase Console → Firestore Database → Rules
2. Look at the Rules section - you should see the permissive rules (match /{document=**})
3. If you see different rules, replace them with the rules from Step 2 above
4. Check browser console for detailed error messages

### Authentication Failures
If tests fail to sign in with error "The password is invalid or the user does not have a password":
1. Go to Firebase Console → Authentication → Users
2. Verify the test user "test@pawse.com" exists
3. If not, create it with password "TestPassword123!"
4. If it exists, try deleting and recreating it

### Test Data Cleanup
Tests attempt to clean up after themselves, but you can manually clean test data:
1. Go to Firebase Console → Firestore Database
2. Look through collections for documents with names starting with "Test" or containing UUID prefixes
3. Delete them as needed

## Alternative: Use Emulators

For isolated testing, consider using Firebase Emulators:

```bash
# Install Firebase CLI if needed
npm install -g firebase-tools

# Start emulators
firebase emulators:start
```

Then update your app to connect to emulators instead of production Firebase.

## Notes

- Auth tests create and delete users dynamically
- Other controller tests assume the test user (`xtYAlZO1IQOvhiUEuI2CHcgZANz1`) exists
- Tests create unique data using UUIDs to avoid conflicts
- Some tests include delays for Firestore indexing (500ms)
